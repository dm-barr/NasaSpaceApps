<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KNN Mapa - Emisiones Forestales (WRI)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body { margin: 0; display: flex; height: 100vh; }
    #map { flex: 1; }
    #panel {
      width: 340px;
      padding: 15px;
      background: #f9f9f9;
      border-left: 2px solid #ccc;
      font-family: Arial, sans-serif;
      overflow-y: auto;
    }
  </style>
</head>
<body>

<div id="map"></div>
<div id="panel">
  <h3>Emisiones Forestales (KNN)</h3>
  <div id="info">Cargando datos del WRI...</div>
</div>

<script>
  // === Inicializar mapa ===
  const map = L.map('map').setView([-7.163, -78.5], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);
  const info = document.getElementById("info");
  const k = 3; // vecinos más cercanos
  let dataset = [];

  // === Paso 1: obtener la metadata del dataset ===
  async function loadWriDataset() {
    try {
      const response = await fetch("https://datasets.wri.org/api/3/action/package_show?id=gfw-forest-carbon-gross-emissions");
      const data = await response.json();

      if (!data.result || !data.result.resources) throw new Error("Sin recursos válidos en API WRI.");

      // Obtener la URL real de los datos (CSV o JSON)
      const resource = data.result.resources.find(r => r.format && r.format.toLowerCase().includes("csv"));
      if (!resource) throw new Error("No se encontró recurso CSV en el dataset.");

      const datasetUrl = resource.url;
      console.log("URL de datos reales:", datasetUrl);

      // Cargar CSV y procesar (simplificado para ejemplo)
      const csvText = await fetch(datasetUrl).then(r => r.text());
      const rows = csvText.split("\n").slice(1, 300); // primeras filas

      // Intentamos extraer columnas relevantes
      dataset = rows.map(r => {
        const cols = r.split(",");
        return {
          pais: cols[0],
          año: cols[1],
          emisiones: parseFloat(cols[2]) || 0,
          lat: -7 + Math.random() * 0.5,   // ⚠️ el dataset no tiene coordenadas exactas
          lon: -78.5 + Math.random() * 0.5
        };
      }).filter(d => !isNaN(d.emisiones));

      info.innerHTML = `✅ Datos del WRI cargados (${dataset.length} registros).<br>Haz clic en el mapa para estimar emisiones.`;
      console.log(dataset.slice(0, 5));

    } catch (error) {
      console.error("Error al cargar WRI:", error);
      info.innerHTML = "❌ No se pudieron cargar los datos del WRI.";
    }
  }

  // === Distancia Euclidiana simple (lat/lon) ===
  function distance(a, b) {
    return Math.sqrt((a.lat - b.lat) ** 2 + (a.lon - b.lon) ** 2);
  }

  // === KNN básico ===
  function predictEmisiones(lat, lon) {
    if (dataset.length === 0) return null;
    const distances = dataset.map(d => ({
      ...d,
      dist: distance({ lat, lon }, d)
    }));
    distances.sort((a, b) => a.dist - b.dist);
    const nearest = distances.slice(0, k);
    const promedio = nearest.reduce((sum, d) => sum + d.emisiones, 0) / k;
    return { promedio, nearest };
  }

  // === Evento clic en mapa ===
  map.on("click", (e) => {
    const { lat, lng } = e.latlng;
    const result = predictEmisiones(lat, lng);

    if (!result) return alert("Los datos aún no se cargan.");

    L.circle([lat, lng], { radius: 800, color: "#0078ff" }).addTo(map);

    info.innerHTML = `
      <b>Coordenadas:</b> ${lat.toFixed(4)}, ${lng.toFixed(4)}<br><br>
      <b>Emisiones estimadas:</b> ${result.promedio.toFixed(2)} tCO₂<br>
      <small>(Basado en ${k} registros más cercanos)</small><br><br>
      <b>Vecinos usados:</b>
      <ul>
        ${result.nearest.map(n => `<li>${n.pais} (${n.año}) → ${n.emisiones.toFixed(2)} tCO₂</li>`).join("")}
      </ul>
    `;
  });

  // === Inicializar ===
  loadWriDataset();
</script>

</body>
</html>
