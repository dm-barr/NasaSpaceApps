<!DOCTYPE html>
<html lang="es">

<head>
   
  <meta charset="utf-8" />
   
  <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Cajamarca Sostenible: Observatorio de Riesgos Urbanos (Leaflet/Cesium REAL)</title>
   
     
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
   
       
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cesium@1.118.0/Build/Cesium/Widgets/widgets.css">

    <style>
    /* ----------------------------------------------------------- */
    /* ---------------------- 🎨 ESTILOS CSS 🎨 ---------------------- */
    /* ----------------------------------------------------------- */
    :root {
      --sidebar-width: 360px;
      --accent: #00695c;
      /* Verde esmeralda */
      --accent-dark: #004d40;
      --muted: #6b6b6b;
      --bg: #f7f9f8;
      --card-bg: #ffffff;
      --radius: 10px;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%;
      margin: 0;
      font-family: Inter, "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      color: #222
    }

    a {
      color: inherit
    }

    /* ------------- Layout principal --------------- */
    #app {
      display: flex;
      height: 100vh;
      width: 100%;
      overflow: hidden;
    }

    /* Contenedor principal del mapa */
    #map-container {
      flex: 1;
      position: relative;
      height: 100vh;
      min-width: 0;
    }

    /* Contenedores de mapa */
    #leaflet-map,
    #cesium-globe {
      position: absolute;
      width: 100%;
      height: 100%;
      transition: opacity 0.5s ease;
    }

    /* Asegura que Cesium tenga el fondo negro por defecto */
    #cesium-globe {
      background: #000;
      display: none;
      /* Oculto por defecto */
    }

    /* Sidebar */
    #sidebar {
      width: var(--sidebar-width);
      background: var(--card-bg);
      padding: 20px;
      box-shadow: -10px 0 30px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
      transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow .3s;
      z-index: 900;
    }

    /* Plegado de sidebar en móvil */
    #sidebar.collapsed {
      transform: translateX(100%);
      box-shadow: none;
    }

    /* Header dentro del sidebar */
    #sidebar header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    #sidebar h2 {
      margin: 0;
      font-size: 1.2rem;
      color: var(--accent-dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Estilo para botones de control */
    #mapmode-btn,
    #menu-toggle,
    #close-sidebar {
      background: var(--card-bg);
      border: 1px solid #e6e6e6;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
      transition: all 0.2s ease;
      font-weight: 500;
    }

    #mapmode-btn:hover,
    #menu-toggle:hover,
    #close-sidebar:hover {
      background: var(--bg);
      border-color: var(--accent);
      color: var(--accent-dark);
    }

    #menu-toggle {
      display: none;
    }

    /* Controles flotantes (Botón 3D y Menú móvil) */
    #map-controls {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 1000;
      display: flex;
      gap: 8px;
    }

    #map-controls.mobile-left {
      right: auto;
      left: 12px;
    }

    #mapmode-btn {
      margin-top: 0;
    }

    /* KPI cards - Más vibrantes */
    #kpi-cards {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      margin-bottom: 10px;
    }

    .kpi-card {
      background: var(--card-bg);
      flex: 1;
      padding: 14px;
      border-radius: var(--radius);
      border-left: 5px solid var(--accent);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s ease;
    }

    .kpi-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    }

    .kpi-card h4 {
      margin: 0;
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--accent)
    }

    .kpi-card p {
      margin: 6px 0 0 0;
      font-size: 1.5rem;
      font-weight: 800;
      color: #333;
      transition: color 0.3s ease;
    }

    /* CSS para el mensaje de modo 3D */
    .mode-3d-message {
      background: #fef0f0;
      color: #d32f2f;
      border-left: 4px solid #d32f2f;
      padding: 10px;
      margin-top: 15px;
      border-radius: 4px;
    }

    /* Estilos responsive */
    @media (max-width: 900px) {
      #sidebar {
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        transform: translateX(100%);
        width: 90%;
        max-width: 400px;
        padding: 15px;
      }

      #sidebar.open {
        transform: translateX(0);
      }

      #kpi-cards {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>
   
    <div id="app">
        <div id="map-container" aria-label="Contenedor del mapa">
           
                  <div id="leaflet-map"></div>
           
                        <div id="cesium-globe"></div>

                  <div id="map-controls">
                <button id="mapmode-btn" title="Cambiar a vista 3D"> 🌍 Cambiar a 3D </button>
                <button id="menu-toggle"> ☰ Menú </button>
              </div>
          </div>

        <aside id="sidebar" aria-label="Panel lateral">
      <header>
        <h2>🗺️ Observatorio de Riesgos — Cajamarca</h2>
        <div style="margin-left:auto; display:flex; gap: 8px;">
          <button id="close-sidebar" title="Cerrar panel" style="display:none">✕</button>
        </div>
      </header>

      <!-- KPI CARDS -->
      <div id="kpi-cards">
        <div class="kpi-card">
          <h4>Área de Alto Riesgo</h4>
          <p id="kpi-alto">--</p>
        </div>
        <div class="kpi-card">
          <h4>Vegetación Crítica (NDVI)</h4>
          <p id="kpi-ndvi">--</p>
          <div id="ndvi-bar" style="height: 5px; background: linear-gradient(to right, #f44336, #ffeb3b, #4caf50);
               border-radius: 2px; margin-top: 5px;">
          </div>
        </div>
      </div>

      <!-- ALERTA DE MODO 3D -->
      <div id="mode-alert" class="mode-3d-message" style="display: none;">
        🚨 <strong>MODO 3D ACTIVO:</strong> Las interacciones de datos (clics, capas)
        se gestionan en Cesium. El panel lateral está en modo de visualización.
      </div>

      <!-- MÓDULO IA -->
      <section class="chart-container">
        <div class="module-header">
          <h4>🤖 Predicción de Riesgo (IA)</h4>
        </div>

        <div id="ai-module">
          <label>Modo:
            <select id="ai-mode">
              <option value="light">Ligero (regla ponderada)</option>
              <option value="tfjs" disabled>Entrenable (TensorFlow.js - REQUIERE LIB.)</option>
            </select>
          </label>

          <label class="range-label-wrap">NDVI:
            <input id="ai-ndvi" type="range" min="0" max="1" step="0.01" value="0.5">
            <span class="value-display">0.50</span>
          </label>

          <label class="range-label-wrap">LST (°C):
            <input id="ai-lst" type="range" min="15" max="45" step="0.1" value="26">
            <span class="value-display">26.0</span>
          </label>

          <label class="range-label-wrap">Densidad (hab/km²):
            <input id="ai-den" type="range" min="0" max="10000" step="1" value="500">
            <span class="value-display">500</span>
          </label>

          <button id="ai-predict">🚀 Calcular Predicción</button>
          <div id="ai-output" style="display:none;"></div>

          <div id="ai-train-area" style="display:none;margin-top:10px;">
            <p style="margin:0 0 8px 0">
              Entrenamiento local (demo) — genera un modelo simple con datos sintéticos.
            </p>
            <button id="ai-train">⚙️ Entrenar modelo (demo)</button>
            <div id="ai-train-output" style="margin-top:8px"></div>
          </div>
        </div>
      </section>

      <!-- DATASETS -->
      <section class="chart-container">
        <h4>📚 Datasets disponibles (WRI)</h4>
        <div id="wri-info">Datos listos para ser usados en análisis geoespacial.</div>
        <div id="wri-datasets">
          <ul id="dataset-list" style="padding-left:20px; margin-top:10px;">
            <li><strong>Emisiones_CO2_2020</strong> (WRI demo) - Contaminación</li>
            <li><strong>Cobertura_bosque_2019</strong> (WRI demo) - Resiliencia</li>
            <li><strong>Riesgo_inundacion_zonas</strong> (WRI demo) - Vulnerabilidad</li>
          </ul>
        </div>
      </section>

      <hr style="margin:16px 0;border:none;border-top:1px solid #eee">

      <!-- DETALLE DE ÁREA SELECCIONADA -->
      <section id="area-info">
        <h3>Detalle del Área Seleccionada (Clic en el Mapa)</h3>
        <p id="click-instruction" style="color:var(--muted)">
          Haz clic en el mapa para ver los datos de <strong>LST</strong>, <strong>NDVI</strong> y
          <strong>Densidad</strong> de esa zona específica.
        </p>
        <div id="selected-metrics"></div>
      </section>

      <!-- GRÁFICO -->
      <section class="chart-container chart-wrap">
        <canvas id="riskChart"></canvas>
      </section>
    </aside>

      </div>

     
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
   
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
     
  <script src="https://cdn.jsdelivr.net/npm/cesium@1.118.0/Build/Cesium/Cesium.js"></script>
   
   
  <script>
    /* ----------------------------------------------------------- */
    /* -------------------- 💻 LÓGICA JAVASCRIPT 💻 ------------------- */
    /* ----------------------------------------------------------- */

    // Variables de control
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menu-toggle');
    const mapControls = document.getElementById('map-controls');
    const closeSidebarBtn = document.getElementById('close-sidebar');
    const mapmodeBtn = document.getElementById('mapmode-btn');
    const leafletMapDiv = document.getElementById('leaflet-map');
    const cesiumGlobeDiv = document.getElementById('cesium-globe');
    const modeAlert = document.getElementById('mode-alert');
    const clickInstruction = document.getElementById('click-instruction');
    const ndviBar = document.getElementById('ndvi-bar');

    // Estado global
    let is3DMode = false;
    let mapInstance = null; // Leaflet instance
    let cesiumViewer = null; // Cesium Viewer instance
    let clickMarker = null;

    // Coordenadas de Cajamarca
    const CAJAMARCA_COORDS = [-7.1667, -78.5]; // Lat, Lng

    /* ----------------- UI: sidebar toggle (responsive) ----------------- */
    function updateResponsiveUI() {
      const w = window.innerWidth;
      if (w <= 900) {
        mapControls.classList.add('mobile-left');
        menuToggle.style.display = 'inline-flex';
        closeSidebarBtn.style.display = 'inline-block';
        sidebar.classList.add('collapsed');
      } else {
        mapControls.classList.remove('mobile-left');
        menuToggle.style.display = 'none';
        closeSidebarBtn.style.display = 'none';
        sidebar.classList.remove('collapsed');
        sidebar.classList.remove('open');
      }
    }
    window.addEventListener('resize', updateResponsiveUI);
    updateResponsiveUI();
    menuToggle && menuToggle.addEventListener('click', () => sidebar.classList.add('open'));
    closeSidebarBtn && closeSidebarBtn.addEventListener('click', () => sidebar.classList.remove('open'));


    /* ----------------- Map initialization: Leaflet ONLY (2D) ----------------- */
    function initLeafletMap() {
      if (mapInstance) mapInstance.remove();

      mapInstance = L.map(leafletMapDiv, { preferCanvas: true }).setView(CAJAMARCA_COORDS, 12);

      // Capa base gratuita de OpenStreetMap (OSM)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(mapInstance);

      // Click handler para Leaflet
      mapInstance.on('click', function (e) {
        if (!is3DMode) handleMapClick({ lng: e.latlng.lng, lat: e.latlng.lat });
      });
    }

    // Llamada inicial
    initLeafletMap();

    /* ----------------- Map initialization: CesiumJS (3D) ----------------- */
    function initCesiumViewer() {
      // 1. Verificar si ya se inicializó
      if (cesiumViewer) return;

      // 2. Configurar Cesium token
      // Cesium requiere un token para algunos servicios (como las imágenes 3D por defecto), aunque el motor es gratuito.
      // Usamos el token de demostración (funciona, pero se recomienda obtener uno propio en https://cesium.com/ion/tokens).
      Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyYTliOTViOC1jYmJmLTQzOWItODg0Ny1hNzg0YzJjYTljY2YiLCJpZCI6MTkzNTQ0LCJpYXQiOjE3MDcwNTEzNDl9.X1-wW1_g9R6yN1_X_e7D2Y3pQe2M5J6eW3d0P1v-f78';

      // 3. Inicializar el visor
      cesiumViewer = new Cesium.Viewer(cesiumGlobeDiv, {
        animation: false, // Desactivar widget de animación
        baseLayerPicker: true, // Permitir cambio de capa base (incluye 3D)
        fullscreenButton: false, // Desactivar botón de pantalla completa
        geocoder: false, // Desactivar geocodificador
        homeButton: false, // Desactivar botón de inicio
        sceneModePicker: false, // Desactivar selector de modo de escena (2D, 3D)
        timeline: false, // Desactivar línea de tiempo
        navigationHelpButton: false, // Desactivar botón de ayuda
        infoBox: false, // Desactivar cuadro de información
        selectionIndicator: false // Desactivar indicador de selección
      });

      // 4. Volar a Cajamarca con inclinación para ver 3D
      cesiumViewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(CAJAMARCA_COORDS[1], CAJAMARCA_COORDS[0], 20000), // Lng, Lat, Altura (20km)
        orientation: {
          heading: Cesium.Math.toRadians(0.0), // Orientación Norte
          pitch: Cesium.Math.toRadians(-35.0), // Ángulo de inclinación
          roll: 0.0
        },
        duration: 1.5 // Duración del vuelo
      });

      console.log('CesiumJS Viewer inicializado.');
    }

    /* ----------------- Función principal de toggle de modo de mapa ----------------- */
    mapmodeBtn.addEventListener('click', toggleMapMode);

    function toggleMapMode() {
      is3DMode = !is3DMode;

      if (is3DMode) {
        // Modo 3D (Cesium)
        initCesiumViewer();
        leafletMapDiv.style.display = 'none';
        cesiumGlobeDiv.style.display = 'block';
        mapmodeBtn.textContent = '📏 Volver a 2D';
        mapmodeBtn.title = 'Cambiar a vista 2D (Leaflet)';
        modeAlert.style.display = 'block';
        clickInstruction.textContent = 'Interacciones de datos deshabilitadas en el modo 3D.';

      } else {
        // Modo 2D (Leaflet)
        leafletMapDiv.style.display = 'block';
        cesiumGlobeDiv.style.display = 'none';
        mapInstance.invalidateSize(); // Asegura que Leaflet se redimensione correctamente
        mapmodeBtn.textContent = '🌍 Cambiar a 3D';
        mapmodeBtn.title = 'Cambiar a vista 3D (CesiumJS)';
        modeAlert.style.display = 'none';
        clickInstruction.textContent = 'Haz clic en el mapa para ver los datos de LST, NDVI y Densidad de esa zona específica.';
      }
    }

    /* -------------- Manejo de clicks en el mapa (simulación de métricas) -------------- */
    function handleMapClick(coords) {
      // Esta función solo se ejecuta si NO estamos en 3D (ver listener en initLeafletMap)

      // 1. Simulación de datos
      const ndvi = (Math.random() * 0.7 + 0.2).toFixed(2); // Rango 0.2 a 0.9
      const lst = (18 + Math.random() * 18).toFixed(1); // Rango 18 a 36
      const dens = Math.round(Math.random() * 6000);

      // 2. Animación del marcador de click (Leaflet)
      if (clickMarker) mapInstance.removeLayer(clickMarker);
      clickMarker = L.circleMarker([coords.lat, coords.lng], {
        radius: 8,
        fillColor: 'var(--accent)',
        color: '#ffffff',
        weight: 2,
        opacity: 1,
        fillOpacity: 0.9
      }).addTo(mapInstance).bindPopup(`Datos: NDVI ${ndvi}, LST ${lst}°C`).openPopup();
      mapInstance.flyTo([coords.lat, coords.lng], 12, { animate: true, duration: 1 });

      // 3. Actualizar panel lateral
      const html = `
        <p><strong>📍 Coordenadas:</strong> ${coords.lat.toFixed(4)}, ${coords.lng.toFixed(4)}</p>
        <p><strong>🌿 NDVI (Salud):</strong> <span style="color:${parseFloat(ndvi) > 0.4 ? 'green' : 'orange'}; font-weight:700;">${ndvi}</span></p>
        <p><strong>🔥 LST (°C):</strong> <span style="color:${parseFloat(lst) > 30 ? 'red' : 'green'}; font-weight:700;">${lst}</span></p>
        <p><strong>👥 Densidad (hab/km²):</strong> <span style="font-weight:700;">${dens.toLocaleString()}</span></p>
      `;
      document.getElementById('selected-metrics').innerHTML = html;

      // 4. Actualizar KPIs, animar riesgo e indicador visual NDVI
      const kpiAlto = document.getElementById('kpi-alto');
      const isHighRisk = (parseFloat(ndvi) < 0.3 || parseFloat(lst) > 32);
      kpiAlto.textContent = isHighRisk ? '¡ALTO! ⚠️' : 'Bajo/Medio ✅';
      kpiAlto.style.color = isHighRisk ? '#ff4500' : 'var(--accent-dark)';
      kpiAlto.classList.toggle('pulsing-kpi', isHighRisk);
      document.getElementById('kpi-ndvi').textContent = ndvi;

      const ndviPercent = parseFloat(ndvi) * 100;
      ndviBar.style.position = 'relative';
      ndviBar.style.cursor = 'pointer';
      ndviBar.innerHTML = `<div style="position: absolute; top: -7px; left: ${ndviPercent}%; transform: translateX(-50%); width: 14px; height: 14px; border-radius: 50%; background: white; border: 2px solid var(--accent-dark); box-shadow: 0 1px 3px rgba(0,0,0,0.3); transition: left 0.5s ease-out;"></div>`;


      // 5. Actualizar gráfico de riesgo
      updateRiskChart(parseFloat(ndvi), parseFloat(lst), dens);

      // 6. Cerrar sidebar si es móvil (mejora UX)
      if (window.innerWidth <= 900) sidebar.classList.remove('open');
    }

    /* ----------------- Sincronización de Range Sliders con valores ----------------- */
    document.querySelectorAll('input[type="range"]').forEach(input => {
      const displaySpan = input.parentNode.querySelector('.value-display');
      if (displaySpan) {
        input.addEventListener('input', () => {
          displaySpan.textContent = parseFloat(input.value).toLocaleString(undefined, {
            minimumFractionDigits: input.step.split('.')[1]?.length || 0,
            maximumFractionDigits: input.step.split('.')[1]?.length || 0
          });
        });
      }
    });

    /* ----------------- IA simple (regla ponderada) ----------------- */
    document.getElementById('ai-predict').addEventListener('click', () => {
      const ndvi = parseFloat(document.getElementById('ai-ndvi').value);
      const lst = parseFloat(document.getElementById('ai-lst').value);
      const dens = parseFloat(document.getElementById('ai-den').value);
      const out = document.getElementById('ai-output');

      // Regla ponderada demo (0-1)
      const risk = Math.min(1, Math.max(0,
        0.5 * (1 - ndvi) + 0.35 * ((lst - 15) / 30) + 0.15 * (dens / 10000)
      ));
      const riskPct = Math.round(risk * 100);

      out.style.display = 'block';
      out.style.backgroundColor = `rgba(255, ${255 - riskPct * 2.55}, ${255 - riskPct * 2.55}, 0.8)`;
      out.innerHTML = `<div>Estimación IA: <strong>Riesgo ${riskPct}%</strong> (${riskPct > 60 ? '¡Alta prioridad!' : 'Prioridad baja/media'}).</div>`;
    });

    // Las funciones de Simulación Climática y FIRMS/WRI se han eliminado para simplificar el código en la respuesta final,
    // ya que el foco es la vista 3D, pero se pueden reintegrar.

    /* ----------------- Gráfico de riesgo (Chart.js) ----------------- */
    const ctx = document.getElementById('riskChart').getContext('2d');
    let riskChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['NDVI', 'LST (°C)', 'Densidad (/1000)'],
        datasets: [{
          label: 'Valor normalizado',
          data: [0.5 * 35, 26, 0.5 * 5], // Escala inicial
          backgroundColor: [
            'rgba(75, 192, 192, 0.7)',
            'rgba(255, 99, 132, 0.7)',
            'rgba(54, 162, 235, 0.7)'
          ],
          borderColor: 'rgba(255, 255, 255, 1)',
          borderWidth: 1,
          borderRadius: 8,
          hoverBackgroundColor: [
            'rgba(75, 192, 192, 0.9)',
            'rgba(255, 99, 132, 0.9)',
            'rgba(54, 162, 235, 0.9)'
          ]
        }]
      },
      options: {
        responsive: true,
        animation: { duration: 800, easing: 'easeOutQuart' },
        plugins: { legend: { display: false } },
        scales: {
          y: {
            beginAtZero: false,
            max: 35,
            ticks: { color: '#666' }
          },
          x: { ticks: { color: '#666' } }
        }
      }
    });

    function updateRiskChart(ndvi, lst, dens) {
      riskChart.data.datasets[0].data = [ndvi * 35, lst, dens / 1000 * 5];
      riskChart.update();
    }
  </script>
</body>

</html>